name: Docker Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build backend
      run: |
        docker build -t anjoman-backend:test ./backend
    
    - name: Build frontend
      run: |
        docker build -t anjoman-frontend:test ./frontend
    
    - name: Test backend container starts
      run: |
        docker run -d --name test-backend \
          -e OPENAI_API_KEY=test-key \
          -e SESSIONS_DIR=/app/data/sessions \
          anjoman-backend:test
        sleep 5
        docker logs test-backend
        docker stop test-backend
    
    - name: Docker Compose build
      run: |
        docker-compose build
    
    - name: Show images
      run: docker images

